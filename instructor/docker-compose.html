<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Introduction to Docker: Using Docker Compose</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png"><link rel="manifest" href="../favicons/incubator/site.webmanifest"><link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-info">
          <abbr title="This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.">
            <a href="https://docs.carpentries.org/resources/curriculum/lesson-life-cycle.html" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-circle" style="border-radius: 5px"></i>
              Beta
            </a>
            <span class="visually-hidden">This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../docker-compose.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Introduction to Docker
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Introduction to Docker
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr></ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to Docker
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 72%" class="percentage">
    72%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 72%" aria-valuenow="72" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../docker-compose.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="introduction.html">1. The adventures of Docker and the Space Purple Unicorn Association</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="docker-desktop.html">2. Docker Desktop</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="docker-cli-toolkit.html">3. Building our Docker CLI toolkit</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="docker-volumes.html">4. Sharing information with containers</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="docker-hub.html">5. The Docker Hub</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="docker-run-configuration.html">6. Configuring containers</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="dockerfiles.html">7. Creating Your Own Container Images</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        8. Using Docker Compose
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#running-a-container">Running a container</a></li>
<li><a href="#configuring-the-container">Configuring the container</a></li>
<li><a href="#building-containers-in-docker-compose">Building containers in Docker Compose</a></li>
<li><a href="#connecting-multiple-services">Connecting multiple services</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="docker-compose-microservices.html">9. And they lived happily ever after</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr></ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/dockerfiles.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/docker-compose-microservices.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/dockerfiles.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Creating Your Own
        </a>
        <a class="chapter-link float-end" href="../instructor/docker-compose-microservices.html" rel="next">
          Next: And they lived...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Using Docker Compose</h1>
        <p>Last updated on 2025-06-10 |

        <a href="https://github.com/UoMResearchIT/docker-introduction/edit/main/episodes/docker-compose.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 198 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>What is Docker Compose?</li>
<li>Why and when would I use it?</li>
<li>How can I translate my <code>docker run</code> commands into a
<code>docker-compose.yml</code> file?</li>
<li>How can I make containers communicate with each other?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Learn how to run multiple containers together.</li>
<li>Clean up our run command for once and for all.</li>
</ul></div>
</div>
</div>
</div>
</div>
<p>We’ve manage to come a long way in making the SPUC container work
better for us, but it still lacks a little something. If we want to open
this service to our local community, we can hardly expect them to hit
the API with a curl command!</p>
<p>Luckily, the SPUA released the SPUC Super Visualiser (SPUCSVi)! The
SPUCSVi is a web-based tool that allows you to register unicorn
sightings, and also see the record of unicorn sightings. Handily, the
SPUA also made it available as a Docker container.</p>
<p>Now that you have seen several <code>docker run</code> commands, you
can well imagine how cumbersome running multiple containers can get.
Even more so if we want the different containers to play well with each
other.</p>
<p>Enter: Docker Compose!</p>
<p>Docker Compose is a tool for defining and running multi-container
applications. With Compose, you use a YAML file to configure your
application’s services. Then, with a single command, you create and
start all the services from your configuration.</p>
<p>Let’s take a look at Docker Compose and see how it can help us run
SPUC and SPUCSVi.</p>
<section><h2 class="section-heading" id="running-a-container">Running a container<a class="anchor" aria-label="anchor" href="#running-a-container"></a></h2>
<hr class="half-width"><p>As an initial step, we will learn how to run a container using Docker
Compose.</p>
<p>The first thing we need to do is create a
<code>docker-compose.yml</code> file. All
<code>docker-compose.yml</code> files start with <code>services:</code>.
This is the root element under which we define the services we want to
run.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span></code></pre>
</div>
<p>Next, let’s add the service for the SPUC container. We’ll call it
<code>spuc</code> and we will tell it what <code>image</code> to
use.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span><span class="co">                            # The name of the service</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span><span class="co">      # The image to use</span></span></code></pre>
</div>
<p>This is actually enough for us to run the container! But we won’t use
<code>docker run</code> any more.</p>
<p>Instead, we will use the base command <code>docker compose</code>. To
run the services, we add the command <code>up</code>, signalling that we
want to bring services up (i.e. start them).</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">docker</span> compose up</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 2/0
 ✔ Network docker_intro_default   Created                           0.1s
 ✔ Container docker_intro-spuc-1  Created                           0.0s
Attaching to spuc-1
spuc-1  |
spuc-1  |             \
spuc-1  |              \
spuc-1  |               \\
spuc-1  |                \\\
spuc-1  |                 &gt;\/7
spuc-1  |             _.-(º   \
spuc-1  |            (=___._/` \            ____  ____  _    _  ____
spuc-1  |                 )  \ |\          / ___||  _ \| |  | |/ ___|
spuc-1  |                /   / ||\         \___ \| |_) | |  | | |
spuc-1  |               /    &gt; /\\\         ___) |  __/| |__| | |___
spuc-1  |              j    &lt; _\           |____/|_|    \____/ \____|
spuc-1  |          _.-' :      ``.
spuc-1  |          \ r=._\        `.       Space Purple Unicorn Counter
spuc-1  |         &lt;`\\_  \         .`-.
spuc-1  |          \ r-7  `-. ._  ' .  `\
spuc-1  |           \`,      `-.`7  7)   )
spuc-1  |            \/         \|  \'  / `-._
spuc-1  |                       ||    .'
spuc-1  |                        \\  (
spuc-1  |                         &gt;\  &gt;
spuc-1  |                     ,.-' &gt;.'
spuc-1  |                    &lt;.'_.''
spuc-1  |                      &lt;'
spuc-1  |
spuc-1  |
spuc-1  | Welcome to the Space Purple Unicorn Counter!
spuc-1  |
spuc-1  | :::: Units set to Imperial Unicorn Hoove Candles [iuhc] ::::
spuc-1  |
spuc-1  | :: Try recording a unicorn sighting with:
spuc-1  |     curl -X PUT localhost:8321/unicorn_spotted?location=moon\&amp;brightness=100
spuc-1  |
spuc-1  | :: No plugins detected
spuc-1  |</code></pre>
</div>
<p>So we have our container running! With a couple of interesting bits
of output to note:</p>
<ul><li>A container was created named <code>docker-intro-spuc-1</code>. (The
directory name is prepended to the container name)</li>
<li>A <code>network</code> was created for the container - we will dig
into what this means later!</li>
<li>The tool is running in the foreground, so we can see the output of
the tool</li>
</ul><p>We can stop the container by pressing <code>[Ctrl+C]</code> in the
terminal.</p>
</section><section><h2 class="section-heading" id="configuring-the-container">Configuring the container<a class="anchor" aria-label="anchor" href="#configuring-the-container"></a></h2>
<hr class="half-width"><p>We have managed to run our container, but we are still a way off from
reproducing our last <code>run</code> command. It’s ok, we need to add
more configuration to our Docker Compose file.</p>
<p>Let’s recall our <code>docker run</code> command for the regular SPUC
container (rather than the one we made ourselves - we’ll get to that in
a bit):</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">--rm</span> <span class="at">--name</span> spuc_container <span class="at">-p</span> 8321:8321 <span class="at">-v</span> ./print.config:/spuc/config/print.config <span class="at">-v</span> spuc-volume:/spuc/output <span class="at">-v</span> stats.py:/spuc/plugins/stats.py <span class="at">-e</span> EXPORT=true spuacv/spuc:latest <span class="at">--units</span> iulu</span></code></pre>
</div>
<p>There are a lot of flags here! Each of these flags has a
corresponding key in Docker Compose. Lets order all the elements we want
in a table, so we can see what we need to add to our
<code>docker-compose.yml</code> file.</p>
<table class="table"><colgroup><col width="45%"><col width="54%"></colgroup><thead><tr class="header"><th>Flag</th>
<th>Description</th>
</tr></thead><tbody><tr class="odd"><td><code>-d</code></td>
<td>Run the container in the background</td>
</tr><tr class="even"><td><code>--rm</code></td>
<td>Remove the container when it stops</td>
</tr><tr class="odd"><td><code>--name spuc_container</code></td>
<td>Name the container <code>spuc_container</code>
</td>
</tr><tr class="even"><td><code>-p 8321:8321</code></td>
<td>Map port 8321 on the host to port 8321 in the container</td>
</tr><tr class="odd"><td><code>-v ./print.config:/spuc/config/print.config</code></td>
<td>Bind mount the <code>./print.config</code> file into the
container</td>
</tr><tr class="even"><td><code>-v spuc-volume:/spuc/output</code></td>
<td>Persist the <code>/spuc/output</code> directory in a volume</td>
</tr><tr class="odd"><td><code>-v ./stats.py:/spuc/plugins/stats.py</code></td>
<td>Bind mount the <code>./stats.py</code> plugin into the
container</td>
</tr><tr class="even"><td><code>-e EXPORT=true</code></td>
<td>Set the environment variable <code>EXPORT</code> to
<code>true</code>
</td>
</tr><tr class="odd"><td><code>--units iulu</code></td>
<td>Set the units to Imperial Unicorn Length Units</td>
</tr></tbody></table><p>We can now start translate this into a Docker Compose file bit by
bit!</p>
<div class="section level3">
<h3 id="running-in-the-background">Running in the background<a class="anchor" aria-label="anchor" href="#running-in-the-background"></a></h3>
<p>To run a docker compose stack in the background, we can use the
<code>-d</code> (for detach) flag when calling
<code>docker compose up</code>.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">$</span> docker compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 1/1
 ✔ Container docker-intro-spuc-1  Started                                   0.2s</code></pre>
</div>
<p>Of course, this means we can no longer see the logs! But we can still
access them using the <code>logs</code> command.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">docker</span> compose logs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>spuc-1  |
spuc-1  |             \
spuc-1  |              \
spuc-1  |               \\
spuc-1  |                \\\
spuc-1  |                 &gt;\/7
spuc-1  |             _.-(º   \
spuc-1  |            (=___._/` \            ____  ____  _    _  ____
spuc-1  |                 )  \ |\          / ___||  _ \| |  | |/ ___|
spuc-1  |                /   / ||\         \___ \| |_) | |  | | |
spuc-1  |               /    &gt; /\\\         ___) |  __/| |__| | |___
spuc-1  |              j    &lt; _\           |____/|_|    \____/ \____|
spuc-1  |          _.-' :      ``.
spuc-1  |          \ r=._\        `.       Space Purple Unicorn Counter
spuc-1  |         &lt;`\\_  \         .`-.
spuc-1  |          \ r-7  `-. ._  ' .  `\
spuc-1  |           \`,      `-.`7  7)   )
spuc-1  |            \/         \|  \'  / `-._
spuc-1  |                       ||    .'
spuc-1  |                        \\  (
spuc-1  |                         &gt;\  &gt;
spuc-1  |                     ,.-' &gt;.'
spuc-1  |                    &lt;.'_.''
spuc-1  |                      &lt;'
spuc-1  |
spuc-1  |
spuc-1  | Welcome to the Space Purple Unicorn Counter!
spuc-1  |
spuc-1  | :::: Units set to Imperial Unicorn Hoove Candles [iuhc] ::::
spuc-1  |
spuc-1  | :: Try recording a unicorn sighting with:
spuc-1  |     curl -X PUT localhost:8321/unicorn_spotted?location=moon\&amp;brightness=100
spuc-1  |
spuc-1  | :: No plugins detected
spuc-1  |
spuc-1  |
spuc-1  |             \
spuc-1  |              \
spuc-1  |               \\
spuc-1  |                \\\
spuc-1  |                 &gt;\/7
spuc-1  |             _.-(º   \
spuc-1  |            (=___._/` \            ____  ____  _    _  ____
spuc-1  |                 )  \ |\          / ___||  _ \| |  | |/ ___|
spuc-1  |                /   / ||\         \___ \| |_) | |  | | |
spuc-1  |               /    &gt; /\\\         ___) |  __/| |__| | |___
spuc-1  |              j    &lt; _\           |____/|_|    \____/ \____|
spuc-1  |          _.-' :      ``.
spuc-1  |          \ r=._\        `.       Space Purple Unicorn Counter
spuc-1  |         &lt;`\\_  \         .`-.
spuc-1  |          \ r-7  `-. ._  ' .  `\
spuc-1  |           \`,      `-.`7  7)   )
spuc-1  |            \/         \|  \'  / `-._
spuc-1  |                       ||    .'
spuc-1  |                        \\  (
spuc-1  |                         &gt;\  &gt;
spuc-1  |                     ,.-' &gt;.'
spuc-1  |                    &lt;.'_.''
spuc-1  |                      &lt;'
spuc-1  |
spuc-1  |
spuc-1  | Welcome to the Space Purple Unicorn Counter!
spuc-1  |
spuc-1  | :::: Units set to Imperial Unicorn Hoove Candles [iuhc] ::::
spuc-1  |
spuc-1  | :: Try recording a unicorn sighting with:
spuc-1  |     curl -X PUT localhost:8321/unicorn_spotted?location=moon\&amp;brightness=100
spuc-1  |
spuc-1  | :: No plugins detected
spuc-1  |</code></pre>
</div>
<p>Now… something a bit funny is happening here… why are we seeing the
output twice?</p>
<p>We’ve actually started the same container twice! We only
<strong>stopped</strong> the container when we pressed
<code>[Ctrl+C]</code>, and didn’t remove it.</p>
</div>
<div class="section level3">
<h3 id="removing-the-container-when-it-stops">Removing the container when it stops<a class="anchor" aria-label="anchor" href="#removing-the-container-when-it-stops"></a></h3>
<p>We can stop and remove the container with the <code>down</code>
command.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">docker</span> compose down</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 2/2
 ✔ Container docker_intro-spuc-1  Removed                                  0.1s
 ✔ Network docker_intro_default   Removed                                  0.2s</code></pre>
</div>
<p>In practice, you only <em>need</em> to use <code>down</code> if you
<em>need</em> to remove the container. If you just want to stop it, you
can use <code>[Ctrl+C]</code> like we did before.</p>
</div>
<div class="section level3">
<h3 id="naming-the-container">Naming the container<a class="anchor" aria-label="anchor" href="#naming-the-container"></a></h3>
<p>The next item in our list is the name of the container. We can name
the container using the <code>container_name</code> key.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span><span class="co">            # The name of the container</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 2/0
 ✔ Network docker-intro_default          Created                           0.0s
 ✔ Container spuc_container              Started                           0.0s</code></pre>
</div>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Updating the compose file
  </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<p>You do not necessarily need to <code>down</code> your containers to
update the configuration, Docker Compose can be <em>smart</em> like
that.</p>
<p>You can update the <code>docker-compose.yml</code> file in your text
editor and then run <code>docker compose up -d</code> to see the changes
take effect.</p>
<p><strong>Warning</strong>: This is not always foolproof! Some changes
will require a rebuild of the container. It is also worth noting that
Docker Compose does not <em>save</em> the status with which you started
your services. When you do a <code>down</code>, it will look at the
<em>current</em> file, and stop the services as described in that
file.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="exporting-a-port">Exporting a port<a class="anchor" aria-label="anchor" href="#exporting-a-port"></a></h3>
<p>Currently, if we attempt to record a sighting of a unicorn, we will
get a connection refused error.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> PUT localhost:8321/unicorn_spotted<span class="pp">?</span>location=asteroid\&amp;brightness=242</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>curl: (7) Failed to connect to localhost port 8321 after 0 ms: Could not connect to server</code></pre>
</div>
<p>This is because we haven’t mapped the port from the container to the
host. We can do this using the <code>ports</code> key using the notation
<code>host_port:container_port</code>.</p>
<p>It’s worth noting the <code>ports</code> key is a list, so we can map
multiple ports if we need to, and that the host and container ports
don’t have to be the same!</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span><span class="co">                          # Starts the list of ports to map</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span><span class="co">                   # Maps port 8321 on the host to port 8321 in the container</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 2/0
 ✔ Network docker-intro_default          Created                           0.0s
 ✔ Container spuc_container              Created                           0.0s</code></pre>
</div>
<p>Now we can record a unicorn sighting!</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> PUT localhost:8321/unicorn_spotted<span class="pp">?</span>location=asteroid\&amp;brightness=242</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="op">{</span><span class="st">"message"</span><span class="op">:</span><span class="st">"Unicorn sighting recorded!"</span><span class="op">}</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="bind-mounts">Bind mounts<a class="anchor" aria-label="anchor" href="#bind-mounts"></a></h3>
<p>As before, we want to make sure that our print configuration is being
used by SPUC. We will use a bind mount for this - mapping a file from
the host to the container.</p>
<p>As with the CLI, this is (confusingly) done using the
<code>volumes</code> key.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span><span class="co">                                        # Starts the list of volumes/bind mounts</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span><span class="co">    # Bind mounts the print.config file</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 2/2
 ✔ Network docker_intro_default  Created                           0.1s
 ✔ Container spuc_container      Started                           0.2s</code></pre>
</div>
<p>Now, if you record some sightings, you should see them formatted
according to the configuration in <code>print.config</code>.</p>
<p>As before, whether a bind mount or volume is performed is based on
whether the argument on the left of the colon is a <em>name</em> or a
<em>path</em>. If it is a <em>path</em> (i.e. starts with <code>/</code>
or <code>./</code>), it generates a bind mount. Otherwise, it generates
a volume.</p>
</div>
<div class="section level3">
<h3 id="volumes">Volumes<a class="anchor" aria-label="anchor" href="#volumes"></a></h3>
<p>Let’s add a volume to persist the unicorn sightings between runs of
the container.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span><span class="co">                  # Mounts the volume named spuc-volume</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>service "spuc" refers to undefined volume spuc-volume: invalid compose project</code></pre>
</div>
<p>Oops! We forgot to declare the volume! Although we added the
instruction to use the volume, we didn’t tell Docker Compose that we
needed that volume.</p>
<p>We can do this by adding a <code>volumes</code> key to the file. The
volumes are separate from <em>services</em>, so they are declared at the
same level. To declare a named volume, we specify its name and end with
a <code>:</code>. We will do this at the end of the file.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span><span class="co">              # Mounts the volume named spuc-volume</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span><span class="co">                                      # Starts section for declaring volumes</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span><span class="co">                                # Declares a volume named spuc-volume</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 2/2
 ✔ Volume "docker_intro_spuc-volume"  Created                            0.0s
 ✔ Container spuc_container           Started                           10.3s</code></pre>
</div>
<p>Now, if you record some sightings and then stop and start the
container, you should see that the sightings are still there!</p>
<p>However, we can now use a cool feature of Docker Compose - the
ability to remove volumes when the container is removed.</p>
<p>We can do this using the <code>-v</code> flag with the
<code>down</code> command. Which tells Docker to remove any volumes
named in the <code>volumes</code> key.</p>
<p>You can confirm this by running <code>docker volume ls</code> before
and after running <code>down</code>.</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="ex">$</span> docker volume ls</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="ex">$</span> docker compose down <span class="at">-v</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a><span class="ex">$</span> docker volume ls</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>DRIVER        VOLUME NAME
local         docker_intro_spuc-volume
local         spuc-volume

[+] Running 3/3
 ✔ Container spuc_container         Removed                   10.2s
 ✔ Volume docker_intro_spuc-volume  Removed                    0.0s
 ✔ Network docker_intro_default     Removed                    0.2s

DRIVER        VOLUME NAME
local         spuc-volume</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="setting-an-environment-variable">Setting an environment variable<a class="anchor" aria-label="anchor" href="#setting-an-environment-variable"></a></h3>
<p>Next, we need to set the <code>EXPORT</code> environment variable to
<code>true</code>. This is done using the <code>environment</code>
key.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="co">                      # Starts list of environment variables to set</span></span>
<span id="cb33-11"><a href="#cb33-11" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span><span class="co">                   # Sets the EXPORT environment variable to true</span></span>
<span id="cb33-12"><a href="#cb33-12" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb33-14"><a href="#cb33-14" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="ex">docker</span> compose logs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[...]
spuc_container  |
spuc_container  | :::: Unicorn sightings export activated! ::::
spuc_container  | :: Try downloading the unicorn sightings record with:
spuc_container  |     curl localhost:8321/export
spuc_container  |</code></pre>
</div>
<p>We can see that the environment variable has been set by the output
of the tool and the export functionality is now available.</p>
</div>
<div class="section level3">
<h3 id="overriding-the-default-command">Overriding the default command<a class="anchor" aria-label="anchor" href="#overriding-the-default-command"></a></h3>
<p>Finally, lets set the units by overriding the command, as we did
before. For this, we use the <code>command</code> key.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb36-9"><a href="#cb36-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb36-10"><a href="#cb36-10" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb36-11"><a href="#cb36-11" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb36-12"><a href="#cb36-12" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span><span class="co">          # Overrides the default command</span></span>
<span id="cb36-13"><a href="#cb36-13" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb36-15"><a href="#cb36-15" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="ex">docker</span> compose logs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[...]
spuc_container  |
spuc_container  | :::: Units set to Intergalactic Unicorn Luminosity Units [iulu] ::::
spuc_container  |
[...]</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="enabling-the-plugin">Enabling the plugin<a class="anchor" aria-label="anchor" href="#enabling-the-plugin"></a></h3>
<p>We’re nearly back to where we were with our <code>docker run</code>
command! The only thing we are missing is enabling the plugin.</p>
<p>We used a bind mount before to put the plugin file in the container,
so lets try again:</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spuc:latest</span></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span><span class="co">        # Mounts the stats.py plugin</span></span>
<span id="cb39-11"><a href="#cb39-11" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb39-12"><a href="#cb39-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb39-13"><a href="#cb39-13" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb39-14"><a href="#cb39-14" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb39-16"><a href="#cb39-16" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 1/1
 ✔ Container spuc_container  Started                            10.3s</code></pre>
</div>
<p>Seems to have worked, lets look at the logs to see if the plugin was
loaded.</p>
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="ex">docker</span> compose logs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>spuc_container  | Traceback (most recent call last):
spuc_container  |   File "/spuc/spuc.py", line 31, in &lt;module&gt;
spuc_container  |     __import__(f"{plugin_dir}.{plugin[:-3]}")
spuc_container  |   File "/spuc/plugins/stats.py", line 4, in &lt;module&gt;
spuc_container  |     import pandas as pd
spuc_container  | ModuleNotFoundError: No module named 'pandas'</code></pre>
</div>
<p>Oh no! We’ve hit an error! The <code>pandas</code> library isn’t
installed in the container - which was the whole reason that we made our
own container in the first place!</p>
<p>Let’s go back to that.</p>
</div>
</section><section><h2 class="section-heading" id="building-containers-in-docker-compose">Building containers in Docker Compose<a class="anchor" aria-label="anchor" href="#building-containers-in-docker-compose"></a></h2>
<hr class="half-width"><p>We could use the tag we used when we built the container to use that
image. However, this would mean that if we want to adjust our locally
built container, we would have to rebuild it separately.</p>
<p>Instead, we can use the <code>build</code> key to tell Docker Compose
to build the container if needed.</p>
<p>To do that, we use the <code>build</code> key instead of the
<code>image</code> key:</p>
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a><span class="co">  # image: spuacv/spuc:latest</span></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span><span class="co">                        # Instead of using the 'image' key, we use the 'build' key</span></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span><span class="co">                  # Sets the build context (the directory in which the Dockerfile is located)</span></span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span><span class="co">      # Sets the name of the Dockerfile</span></span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span></code></pre>
</div>
<p>This tells docker compose to look for the Dockerfile in the current
directory. If needed, it will then build the container and tag it with
the current directory and service names.</p>
<p>Now, we have to be a little careful with our up command! If we run
<code>up</code>, Docker Compose will default to checking if the image
exists and if it does, it will use that image. This is ok… unless we
have made changes to the Dockerfile!</p>
<p>To ensure that the image is built, we can run
<code>docker compose build</code>. This will build (all) the image(s)
specified inside our <code>docker-compose.yml</code>. After building, we
use the usual <code>up</code> command.</p>
<p>Alternatively, we can add the <code>--build</code> flag to the
<code>up</code> command, which results in Docker building the image
right before starting the container. This will rebuild the image every
time you run it, but use cached layers if they exist.</p>
<p>Let’s start our services using that flag, and verify that the plugin
is loaded.</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">--build</span> <span class="at">-d</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="ex">docker</span> compose logs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Building 9.2s (10/10) FINISHED                                                        docker:default
 =&gt; [spuc internal] load build definition from Dockerfile                                           0.0s
 =&gt; =&gt; transferring dockerfile: 250B                                                                0.0s
 =&gt; [spuc internal] load metadata for docker.io/spuacv/spuc:latest                                  0.0s
 =&gt; [spuc internal] load .dockerignore                                                              0.0s
 =&gt; =&gt; transferring context: 2B                                                                     0.0s
 =&gt; [spuc 1/4] FROM docker.io/spuacv/spuc:latest                                                    0.1s
 =&gt; [spuc internal] load build context                                                              0.0s
 =&gt; =&gt; transferring context: 546B                                                                   0.0s
 =&gt; [spuc 2/4] RUN pip install pandas                                                               8.5s
 =&gt; [spuc 3/4] COPY stats.py /spuc/plugins/stats.py                                                 0.0s
 =&gt; [spuc 4/4] COPY print.config /spuc/config/print.config                                          0.0s
 =&gt; [spuc] exporting to image                                                                       0.5s
 =&gt; =&gt; exporting layers                                                                             0.5s
 =&gt; =&gt; writing image sha256:b17d7f75ac398b083476cc3fda502875b1d1355b59ad2bdc9d0526f202be9c05        0.0s
 =&gt; =&gt; naming to docker.io/library/docker_intro-spuc                                                0.0s
 =&gt; [spuc] resolving provenance for metadata file                                                   0.0s
[+] Running 1/1
 ✔ Container spuc_container  Started                                                                0.3s
[...]
spuc_container  |
spuc_container  | :::: Plugins loaded! ::::
spuc_container  | :: Available plugins
spuc_container  |     stats.py
spuc_container  |
[...]</code></pre>
</div>
<p>You should now have a container running with the stats plugin
enabled!</p>
<div id="accordionSpoiler2" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler2" aria-expanded="false" aria-controls="collapseSpoiler2">
  <h3 class="accordion-header" id="headingSpoiler2">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Simpler Dockerfile
  </h3>
</button>
<div id="collapseSpoiler2" class="accordion-collapse collapse" aria-labelledby="headingSpoiler2" data-bs-parent="#accordionSpoiler2">
<div class="accordion-body">
<p>You may have noticed that we ended up <em>duplicating</em> most of
the configuration from the Dockerfile within the
<code>docker-compose.yml</code> file.</p>
<p>In reality, if we are using Docker Compose we do not need to bake in
all of the configuration inside the Dockerfile. The only thing that was
different was the <code>pip install pandas</code> command. Therefore,
our dockerfile could be as simple as this:</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">DOCKERFILE<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode dockerfile" tabindex="0"><code class="sourceCode dockerfile"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="kw">FROM</span> spuacv/spuc:latest</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install pandas</span></code></pre>
</div>
<p>Alternatively, we could simplify our <code>docker-compose.yml</code>
file by removing the duplicated configuration. However, this would make
the <code>docker-compose.yml</code> file less self-contained and more
dependent on the Dockerfile. It is usually a better idea to keep the
configuration in the <code>docker-compose.yml</code> file, as it makes
it easier to understand and maintain.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="connecting-multiple-services">Connecting multiple services<a class="anchor" aria-label="anchor" href="#connecting-multiple-services"></a></h2>
<hr class="half-width"><p>We have now managed to replicate our <code>docker run</code> command
in a more readable and maintainable way.</p>
<p>There is an argument to be made that, even for running a single
service, Docker Compose is a useful tool. It brings an ephemeral run
command, that would need careful documentation to replicate, into a
single file that can be version controlled and shared. It is also much
easier on the eye than a long <code>docker run</code> command!</p>
<p>Where Docker Compose really shines, though, is when you have multiple
services that need to be run together. And we happen to have another
service that we need to run - SPUCSVi!</p>
<div class="section level3">
<h3 id="adding-spucsvi-to-our-docker-compose-file">Adding SPUCSVi to our Docker Compose file<a class="anchor" aria-label="anchor" href="#adding-spucsvi-to-our-docker-compose-file"></a></h3>
<p>We can add SPUCSVi to our Docker Compose file in the same way that we
added SPUC, by adding another service to the <code>services</code>
key.</p>
<p>The SPUCSVi documentation helpfully provides a table of configuration
options what we can use to configure the service, reproduced here:</p>
<table class="table"><colgroup><col width="11%"><col width="59%"><col width="28%"></colgroup><thead><tr class="header"><th>Item</th>
<th>Description</th>
<th>Default</th>
</tr></thead><tbody><tr class="odd"><td>Image Name</td>
<td>The name of the image to use</td>
<td><code>spuacv/spucsvi:latest</code></td>
</tr><tr class="even"><td>Port</td>
<td>The container port the service runs on</td>
<td><code>8322</code></td>
</tr><tr class="odd"><td>SPUC_URL</td>
<td>An environment variable to set the URL of the SPUC service</td>
<td><code>http://spuc:8321</code></td>
</tr></tbody></table><p>We can use this to add SPUCSVi to our Docker Compose file!</p>
<p>But how do we know the correct URL for the SPUC service? This touches
on a couple of clever tricks that Docker Compose uses to make running
multiple services easier.</p>
<p>First, Docker Compose creates a network for each stack that it
starts. This means that, unless overridden, all services in the stack
can communicate with each other.</p>
<p>Second, Docker Compose uses the service name as the hostname for the
service. This means that we can use the service name as the hostname in
the URL! For our service named <code>spuc</code>, the hostname would be
<code>spuc</code> with the protocol <code>http</code> prepended and
<code>port</code> appended i.e. <code>http://spuc:8321</code>.</p>
<p>Knowing this, we are able to add SPUCSVi to our Docker Compose
file!</p>
<div class="codewrapper sourceCode" id="cb48">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span></span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 8321:8321</span></span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb48-11"><a href="#cb48-11" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb48-12"><a href="#cb48-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb48-13"><a href="#cb48-13" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb48-14"><a href="#cb48-14" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb48-15"><a href="#cb48-15" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb48-16"><a href="#cb48-16" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" tabindex="-1"></a><span class="at">  </span><span class="fu">spucsvi</span><span class="kw">:</span><span class="co">                            # Declare a new service named spucsvi</span></span>
<span id="cb48-18"><a href="#cb48-18" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spucsvi:latest</span><span class="co">      # Specify the image to use</span></span>
<span id="cb48-19"><a href="#cb48-19" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spucsvi_container</span><span class="co"> # Name the container spucsvi</span></span>
<span id="cb48-20"><a href="#cb48-20" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span><span class="co">                            # </span></span>
<span id="cb48-21"><a href="#cb48-21" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8322:8322"</span><span class="co">                   # Map port 8322 on the host to port 8322 in the container</span></span>
<span id="cb48-22"><a href="#cb48-22" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="co">                      # </span></span>
<span id="cb48-23"><a href="#cb48-23" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> SPUC_URL=http://spuc:8321</span><span class="co">     # Specify the SPUC_URL environment variable</span></span>
<span id="cb48-24"><a href="#cb48-24" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb48-26"><a href="#cb48-26" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<p>Now both services will be started at the same time!</p>
<div class="codewrapper sourceCode" id="cb49">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="ex">docker</span> compose logs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 3/3
 ✔ Network docker_intro_default  Created                                                           0.1s
 ✔ Container spuc_container      Created                                                           0.0s
 ✔ Container spucsvi_container   Created                                                           0.0s
Attaching to spuc_container, spucsvi_container
spuc_container     |
spuc_container     |             \
spuc_container     |              \
spuc_container     |               \\
spuc_container     |                \\\
spuc_container     |                 &gt;\/7
spuc_container     |             _.-(º   \
spuc_container     |            (=___._/` \            ____  ____  _    _  ____
spuc_container     |                 )  \ |\          / ___||  _ \| |  | |/ ___|
spuc_container     |                /   / ||\         \___ \| |_) | |  | | |
spuc_container     |               /    &gt; /\\\         ___) |  __/| |__| | |___
spuc_container     |              j    &lt; _\           |____/|_|    \____/ \____|
spuc_container     |          _.-' :      ``.
spuc_container     |          \ r=._\        `.       Space Purple Unicorn Counter
spuc_container     |         &lt;`\\_  \         .`-.
spuc_container     |          \ r-7  `-. ._  ' .  `\
spuc_container     |           \`,      `-.`7  7)   )
spuc_container     |            \/         \|  \'  / `-._
spuc_container     |                       ||    .'
spuc_container     |                        \\  (
spuc_container     |                         &gt;\  &gt;
spuc_container     |                     ,.-' &gt;.'
spuc_container     |                    &lt;.'_.''
spuc_container     |                      &lt;'
spuc_container     |
spuc_container     |
spuc_container     | Welcome to the Space Purple Unicorn Counter!
spuc_container     |
spuc_container     | :::: Units set to Imperial Unicorn Hoove Candles [iuhc] ::::
spuc_container     |
spuc_container     | :: Try recording a unicorn sighting with:
spuc_container     |     curl -X PUT localhost:8321/unicorn_spotted?location=moon\&amp;brightness=100
spuc_container     |
spuc_container     | :::: Plugins loaded! ::::
spuc_container     | :: Available plugins
spuc_container     |     stats.py
spuc_container     |
spuc_container     | :::: Unicorn sightings export activated! ::::
spuc_container     | :: Try downloading the unicorn sightings record with:
spuc_container     |     curl localhost:8321/export
spuc_container     |
spucsvi_container  |
spucsvi_container  |      .-'''-. .-------.   ___    _     _______      .-'''-. ,---.  ,---..-./`)
spucsvi_container  |     / _     \\  _(`)_ \.'   |  | |   /   __  \    / _     \|   /  |   |\ .-.')
spucsvi_container  |    (`' )/`--'| (_ o._)||   .'  | |  | ,_/  \__)  (`' )/`--'|  |   |  .'/ `-' \
spucsvi_container  |   (_ o _).   |  (_,_) /.'  '_  | |,-./  )       (_ o _).   |  | _ |  |  `-'`"`
spucsvi_container  |    (_,_). '. |   '-.-' '   ( \.-.|\  '_ '`)      (_,_). '. |  _( )_  |  .---.
spucsvi_container  |   .---.  \  :|   |     ' (`. _` /| &gt; (_)  )  __ .---.  \  :\ (_ o._) /  |   |
spucsvi_container  |   \    `-'  ||   |     | (_ (_) _)(  .  .-'_/  )\    `-'  | \ (_,_) /   |   |
spucsvi_container  |    \       / /   )      \ /  . \ / `-'`-'     /  \       /   \     /    |   |
spucsvi_container  |     `-...-'  `---'       ``-'`-''    `._____.'    `-...-'     `---`     '---'
spucsvi_container  |
spucsvi_container  |     :::: SPUC Super Visualizer serving on localhost:8322 ::::
spucsvi_container  |</code></pre>
</div>
<p>As the logs suggest, we can now view the SPUCSVi interface by
visiting <code>localhost:8322</code> in our browser.</p>
<p>A visual treat awaits, and an easier way to record and view our
unicorn sightings!</p>
</div>
<div class="section level3">
<h3 id="networks">Networks<a class="anchor" aria-label="anchor" href="#networks"></a></h3>
<p>We briefly mentioned networks earlier, noting that, by default,
Docker Compose creates a network for each stack.</p>
<p>However, by overriding the default network, we can perform some
interesting tricks.</p>
<p>Now that we can record Unicorns using the SPUCSVi interface, we don’t
need to be able to access the SPUC service directly.</p>
<p>This means we can isolate the SPUC service from the host network.
This is a good security practice and helps keep things tidy.</p>
<p>To do this we need to stop exposing the ports for SPUC, by removing
the <code>ports</code> key from the SPUC service:</p>
<div class="codewrapper sourceCode" id="cb51">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span></span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a><span class="co">    # ports:                            # We can remove these two lines</span></span>
<span id="cb51-8"><a href="#cb51-8" tabindex="-1"></a><span class="co">    #   - 8321:8321</span></span>
<span id="cb51-9"><a href="#cb51-9" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb51-10"><a href="#cb51-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb51-11"><a href="#cb51-11" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb51-12"><a href="#cb51-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb51-13"><a href="#cb51-13" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb51-14"><a href="#cb51-14" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb51-15"><a href="#cb51-15" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb51-16"><a href="#cb51-16" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" tabindex="-1"></a><span class="at">  </span><span class="fu">spucsvi</span><span class="kw">:</span></span>
<span id="cb51-18"><a href="#cb51-18" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spucsvi:latest</span></span>
<span id="cb51-19"><a href="#cb51-19" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spucsvi</span></span>
<span id="cb51-20"><a href="#cb51-20" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb51-21"><a href="#cb51-21" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8322:8322"</span></span>
<span id="cb51-22"><a href="#cb51-22" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb51-23"><a href="#cb51-23" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> SPUC_URL=http://spuc:8321</span></span>
<span id="cb51-24"><a href="#cb51-24" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb51-26"><a href="#cb51-26" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb52">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<p>Now, the SPUC service is only accessible from within the Docker
network! Try doing a curl to register a sighting and you wont be able
to. However, you can still register sightings through the SPUCSVi
interface.</p>
<p>This can be taken further to create networks with very limited
purposes. For example in a typical web app you may make it so that the
frontend can connect only to backend, but not to the database.</p>
<div id="accordionSpoiler3" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler3" aria-expanded="false" aria-controls="collapseSpoiler3">
  <h3 class="accordion-header" id="headingSpoiler3">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Network names
  </h3>
</button>
<div id="collapseSpoiler3" class="accordion-collapse collapse" aria-labelledby="headingSpoiler3" data-bs-parent="#accordionSpoiler3">
<div class="accordion-body">
<p>You may have noticed that the network that Docker Compose created for
our stack is named <code>docker_intro_default</code>. This is because
Docker Compose uses the name of the directory that the
<code>docker-compose.yml</code> file is in as the name of the
network.</p>
<p>If you want to specify the name of the network, you can use the
<code>networks</code> key in the <code>docker-compose.yml</code> file.
You also need to specify the network name for each service that you want
to connect to the network.</p>
<p>For example, to specify the network name as
<code>spuc_network</code>, you would add the following to the file:</p>
<div class="codewrapper sourceCode" id="cb53">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span></span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb53-8"><a href="#cb53-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb53-9"><a href="#cb53-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb53-10"><a href="#cb53-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb53-11"><a href="#cb53-11" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb53-12"><a href="#cb53-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb53-13"><a href="#cb53-13" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb53-14"><a href="#cb53-14" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span><span class="co">                         # Starts list of networks to connect this service to</span></span>
<span id="cb53-15"><a href="#cb53-15" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc_network</span><span class="co">                  # Connects to the spuc_network network</span></span>
<span id="cb53-16"><a href="#cb53-16" tabindex="-1"></a></span>
<span id="cb53-17"><a href="#cb53-17" tabindex="-1"></a><span class="at">  </span><span class="fu">spucsvi</span><span class="kw">:</span></span>
<span id="cb53-18"><a href="#cb53-18" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spucsvi:latest</span></span>
<span id="cb53-19"><a href="#cb53-19" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spucsvi</span></span>
<span id="cb53-20"><a href="#cb53-20" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb53-21"><a href="#cb53-21" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8322:8322"</span></span>
<span id="cb53-22"><a href="#cb53-22" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb53-23"><a href="#cb53-23" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> SPUC_URL=http://spuc:8321</span></span>
<span id="cb53-24"><a href="#cb53-24" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span><span class="co">                         # Starts list of networks to connect this service to</span></span>
<span id="cb53-25"><a href="#cb53-25" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc_network</span><span class="co">                  # Connects to the spuc_network network</span></span>
<span id="cb53-26"><a href="#cb53-26" tabindex="-1"></a></span>
<span id="cb53-27"><a href="#cb53-27" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb53-28"><a href="#cb53-28" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span>
<span id="cb53-29"><a href="#cb53-29" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" tabindex="-1"></a><span class="fu">networks</span><span class="kw">:</span><span class="co">                             # Starts section for declaring networks</span></span>
<span id="cb53-31"><a href="#cb53-31" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc_network</span><span class="kw">:</span><span class="co">                       # Declares a network for spuc</span></span>
<span id="cb53-32"><a href="#cb53-32" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> spuc_network</span><span class="co">                # Specifies the name of the network</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="depends-on">Depends on<a class="anchor" aria-label="anchor" href="#depends-on"></a></h3>
<p>There is an important problem that we haven’t addressed yet - what
happens if the SPUCSVi service starts before the SPUC service?</p>
<p>This is a common problem when running multiple services together -
services that depend on each other need to start in a specific
order.</p>
<p>Docker Compose has a solution to this - the <code>depends_on</code>
key.</p>
<p>We can use this key to tell Docker Compose that the SPUCSVi service
depends on the SPUC service.</p>
<div class="codewrapper sourceCode" id="cb54">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb54-14"><a href="#cb54-14" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" tabindex="-1"></a><span class="at">  </span><span class="fu">spucsvi</span><span class="kw">:</span></span>
<span id="cb54-16"><a href="#cb54-16" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spucsvi:latest</span></span>
<span id="cb54-17"><a href="#cb54-17" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spucsvi</span></span>
<span id="cb54-18"><a href="#cb54-18" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb54-19"><a href="#cb54-19" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8322:8322"</span></span>
<span id="cb54-20"><a href="#cb54-20" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb54-21"><a href="#cb54-21" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> SPUC_URL=http://spuc:8321</span></span>
<span id="cb54-22"><a href="#cb54-22" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span><span class="co">                     # Starts section for declaring dependencies</span></span>
<span id="cb54-23"><a href="#cb54-23" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc</span><span class="co">                        # Declares that the spucsvi service depends on the spuc service</span></span>
<span id="cb54-24"><a href="#cb54-24" tabindex="-1"></a></span>
<span id="cb54-25"><a href="#cb54-25" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb54-26"><a href="#cb54-26" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<p>Now, when we run <code>docker compose up</code>, the SPUCSVi service
will wait until SPUC has started before it starts.</p>
<p>But there is a catch! The <code>depends_on</code> key only ensures
that the service is started in the correct order. It doesn’t check if
the service is <em>ready</em>!</p>
<p>This can be a problem if a service is fast to start but slow to be
ready. For example, a database service may start quickly, but take a
while to be ready to accept connections.</p>
<p>To address this, Docker Compose allows you to define a
<code>healthcheck</code> for a service. This is a command that is run
periodically (from inside the container) to check if the service is
<em>ready</em>. The command failing (returning a non-zero exit code)
means that the service is not ready.</p>
<p>We can try this out by adding a <code>healthcheck</code> to the SPUC
service. Since we don’t want SPUCSVi to start until the record of
unicorn sightings is ready, we can use the <code>curl</code> command to
check if the <code>/export</code> endpoint is available. We need to add
the <code>--fail</code> flag to <code>curl</code> to ensure that it
returns a non-zero exit code if the endpoint is not available.</p>
<p>The other change we need to make is to add a <code>condition</code>
to the <code>depends_on</code> key in the SPUCSVi service. This tells
Docker Compose to only start the service if the service it depends on is
<em>healthy</em>, rather than just <em>started</em>.</p>
<div class="codewrapper sourceCode" id="cb55">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span></span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb55-7"><a href="#cb55-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb55-8"><a href="#cb55-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb55-9"><a href="#cb55-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb55-10"><a href="#cb55-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb55-11"><a href="#cb55-11" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb55-12"><a href="#cb55-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb55-13"><a href="#cb55-13" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb55-14"><a href="#cb55-14" tabindex="-1"></a><span class="at">    </span><span class="fu">healthcheck</span><span class="kw">:</span><span class="co">                                                  # Starts section for declaring healthchecks</span></span>
<span id="cb55-15"><a href="#cb55-15" tabindex="-1"></a><span class="at">      </span><span class="fu">test</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"CMD"</span><span class="kw">,</span><span class="at"> </span><span class="st">"curl"</span><span class="kw">,</span><span class="at"> </span><span class="st">"--fail"</span><span class="kw">,</span><span class="at"> </span><span class="st">"http://spuc:8321/export"</span><span class="kw">]</span><span class="co">  # Specifies the healthcheck command (ran from inside the container)</span></span>
<span id="cb55-16"><a href="#cb55-16" tabindex="-1"></a><span class="at">      </span><span class="fu">interval</span><span class="kw">:</span><span class="at"> 3s</span><span class="co">                                                # Specifies the interval between healthchecks</span></span>
<span id="cb55-17"><a href="#cb55-17" tabindex="-1"></a><span class="at">      </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 2s</span><span class="co">                                                 # Specifies the timeout for the healthcheck</span></span>
<span id="cb55-18"><a href="#cb55-18" tabindex="-1"></a><span class="at">      </span><span class="fu">retries</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span><span class="co">                                                  # Specifies the number of retries before failing completely</span></span>
<span id="cb55-19"><a href="#cb55-19" tabindex="-1"></a></span>
<span id="cb55-20"><a href="#cb55-20" tabindex="-1"></a><span class="at">  </span><span class="fu">spucsvi</span><span class="kw">:</span></span>
<span id="cb55-21"><a href="#cb55-21" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spucsvi:latest</span></span>
<span id="cb55-22"><a href="#cb55-22" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spucsvi</span></span>
<span id="cb55-23"><a href="#cb55-23" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb55-24"><a href="#cb55-24" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8322:8322"</span></span>
<span id="cb55-25"><a href="#cb55-25" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb55-26"><a href="#cb55-26" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> SPUC_URL=http://spuc:8321</span></span>
<span id="cb55-27"><a href="#cb55-27" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb55-28"><a href="#cb55-28" tabindex="-1"></a><span class="at">      </span><span class="fu">spuc</span><span class="kw">:</span><span class="co">                                                       # This changed from a list (- spuc) to a mapping (spuc:)</span></span>
<span id="cb55-29"><a href="#cb55-29" tabindex="-1"></a><span class="at">        </span><span class="fu">condition</span><span class="kw">:</span><span class="at"> service_healthy</span><span class="co">                                # Specifies further conditions for starting the service</span></span>
<span id="cb55-30"><a href="#cb55-30" tabindex="-1"></a></span>
<span id="cb55-31"><a href="#cb55-31" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb55-32"><a href="#cb55-32" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<p>Now, when we run <code>docker compose up</code>, the SPUCSVi service
will only start when the SPUC service is <em>ready</em>.</p>
<div id="accordionSpoiler4" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler4" aria-expanded="false" aria-controls="collapseSpoiler4">
  <h3 class="accordion-header" id="headingSpoiler4">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Simulating a slow start
  </h3>
</button>
<div id="collapseSpoiler4" class="accordion-collapse collapse" aria-labelledby="headingSpoiler4" data-bs-parent="#accordionSpoiler4">
<div class="accordion-body">
<p>This is a little hard to see in action as the SPUC service starts so
quickly. To be able to see it, let’s add a <code>sleep</code> command to
the <code>entrypoint</code> of the SPUC service to simulate a slow
start.</p>
<div class="codewrapper sourceCode" id="cb56">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span></span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb56-9"><a href="#cb56-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb56-10"><a href="#cb56-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb56-11"><a href="#cb56-11" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb56-12"><a href="#cb56-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=true</span></span>
<span id="cb56-13"><a href="#cb56-13" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb56-14"><a href="#cb56-14" tabindex="-1"></a><span class="at">    </span><span class="fu">entrypoint</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"sh"</span><span class="kw">,</span><span class="at"> </span><span class="st">"-c"</span><span class="kw">,</span><span class="at"> </span><span class="st">"sleep 5 &amp;&amp; python /spuc/spuc.py"</span><span class="kw">]</span><span class="co">   # Adds a sleep command to the entrypoint to simulate a slow start</span></span>
<span id="cb56-15"><a href="#cb56-15" tabindex="-1"></a><span class="at">    </span><span class="fu">healthcheck</span><span class="kw">:</span></span>
<span id="cb56-16"><a href="#cb56-16" tabindex="-1"></a><span class="at">      </span><span class="fu">test</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"CMD"</span><span class="kw">,</span><span class="at"> </span><span class="st">"curl"</span><span class="kw">,</span><span class="at"> </span><span class="st">"--fail"</span><span class="kw">,</span><span class="at"> </span><span class="st">"http://spuc:8321/export"</span><span class="kw">]</span></span>
<span id="cb56-17"><a href="#cb56-17" tabindex="-1"></a><span class="at">      </span><span class="fu">interval</span><span class="kw">:</span><span class="at"> 3s</span></span>
<span id="cb56-18"><a href="#cb56-18" tabindex="-1"></a><span class="at">      </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 2s</span></span>
<span id="cb56-19"><a href="#cb56-19" tabindex="-1"></a><span class="at">      </span><span class="fu">retries</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb56-20"><a href="#cb56-20" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" tabindex="-1"></a><span class="at">  </span><span class="fu">spucsvi</span><span class="kw">:</span></span>
<span id="cb56-22"><a href="#cb56-22" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spucsvi:latest</span></span>
<span id="cb56-23"><a href="#cb56-23" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spucsvi</span></span>
<span id="cb56-24"><a href="#cb56-24" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb56-25"><a href="#cb56-25" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8322:8322"</span></span>
<span id="cb56-26"><a href="#cb56-26" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb56-27"><a href="#cb56-27" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> SPUC_URL=http://spuc:8321</span></span>
<span id="cb56-28"><a href="#cb56-28" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb56-29"><a href="#cb56-29" tabindex="-1"></a><span class="at">      </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb56-30"><a href="#cb56-30" tabindex="-1"></a><span class="at">       </span><span class="fu">condition</span><span class="kw">:</span><span class="at"> service_healthy</span></span>
<span id="cb56-31"><a href="#cb56-31" tabindex="-1"></a></span>
<span id="cb56-32"><a href="#cb56-32" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb56-33"><a href="#cb56-33" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb57">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 3/3
 ✔ Network docker_intro_default  Created                                   0.1s
 ✔ Container spuc_container      Healthy                                   6.7s
 ✔ Container spucsvi_container   Started                                   6.8s</code></pre>
</div>
<p>As yoy can see, the SPUCSVi service only started after the SPUC
service was healthy.</p>
</div>
</div>
</div>
</div>
<div id="accordionSpoiler5" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler5" aria-expanded="false" aria-controls="collapseSpoiler5">
  <h3 class="accordion-header" id="headingSpoiler5">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Simulating an unhealthy service
  </h3>
</button>
<div id="collapseSpoiler5" class="accordion-collapse collapse" aria-labelledby="headingSpoiler5" data-bs-parent="#accordionSpoiler5">
<div class="accordion-body">
<p>To simulate a service that does not pass the healthcheck, we can set
the <code>EXPORT</code> environment variable to <code>false</code> in
the SPUC service. This will mean that the export endpoint is not
available, so the healthcheck will fail.</p>
<div class="codewrapper sourceCode" id="cb59">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a><span class="at">      </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a><span class="at">      </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> Dockerfile</span></span>
<span id="cb59-6"><a href="#cb59-6" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spuc_container</span></span>
<span id="cb59-7"><a href="#cb59-7" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb59-8"><a href="#cb59-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./print.config:/spuc/config/print.config</span></span>
<span id="cb59-9"><a href="#cb59-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> spuc-volume:/spuc/output</span></span>
<span id="cb59-10"><a href="#cb59-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ./stats.py:/spuc/plugins/stats.py</span></span>
<span id="cb59-11"><a href="#cb59-11" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb59-12"><a href="#cb59-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> EXPORT=false</span><span class="co">                                # Sets the EXPORT environment variable to false</span></span>
<span id="cb59-13"><a href="#cb59-13" tabindex="-1"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"--units"</span><span class="kw">,</span><span class="at"> </span><span class="st">"iulu"</span><span class="kw">]</span></span>
<span id="cb59-14"><a href="#cb59-14" tabindex="-1"></a><span class="at">    </span><span class="fu">healthcheck</span><span class="kw">:</span></span>
<span id="cb59-15"><a href="#cb59-15" tabindex="-1"></a><span class="at">      </span><span class="fu">test</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"CMD"</span><span class="kw">,</span><span class="at"> </span><span class="st">"curl"</span><span class="kw">,</span><span class="at"> </span><span class="st">"--fail"</span><span class="kw">,</span><span class="at"> </span><span class="st">"http://spuc:8321/export"</span><span class="kw">]</span></span>
<span id="cb59-16"><a href="#cb59-16" tabindex="-1"></a><span class="at">      </span><span class="fu">interval</span><span class="kw">:</span><span class="at"> 3s</span></span>
<span id="cb59-17"><a href="#cb59-17" tabindex="-1"></a><span class="at">      </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 2s</span></span>
<span id="cb59-18"><a href="#cb59-18" tabindex="-1"></a><span class="at">      </span><span class="fu">retries</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb59-19"><a href="#cb59-19" tabindex="-1"></a></span>
<span id="cb59-20"><a href="#cb59-20" tabindex="-1"></a><span class="at">  </span><span class="fu">spucsvi</span><span class="kw">:</span></span>
<span id="cb59-21"><a href="#cb59-21" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> spuacv/spucsvi:latest</span></span>
<span id="cb59-22"><a href="#cb59-22" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> spucsvi</span></span>
<span id="cb59-23"><a href="#cb59-23" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb59-24"><a href="#cb59-24" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8322:8322"</span></span>
<span id="cb59-25"><a href="#cb59-25" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb59-26"><a href="#cb59-26" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> SPUC_URL=http://spuc:8321</span></span>
<span id="cb59-27"><a href="#cb59-27" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb59-28"><a href="#cb59-28" tabindex="-1"></a><span class="at">      </span><span class="fu">spuc</span><span class="kw">:</span></span>
<span id="cb59-29"><a href="#cb59-29" tabindex="-1"></a><span class="at">       </span><span class="fu">condition</span><span class="kw">:</span><span class="at"> service_healthy</span></span>
<span id="cb59-30"><a href="#cb59-30" tabindex="-1"></a></span>
<span id="cb59-31"><a href="#cb59-31" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb59-32"><a href="#cb59-32" tabindex="-1"></a><span class="at">  </span><span class="fu">spuc-volume</span><span class="kw">:</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb60">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[+] Running 3/3
 ✔ Network docker_intro_default  Created                                                            0.1s
 ✘ Container spuc_container      Error                                                             15.7s
 ✔ Container spucsvi_container   Created                                                            0.0s
dependency failed to start: container spuc_container is unhealthy</code></pre>
</div>
<p>The SPUC service shows an error, because it failed all 5 retries, and
the SPUCSVi service was not started.</p>
<p><strong>Warning</strong>: Even though <em>unhealthy</em>, the
<code>spuc_container</code> is running. You can check this by running
<code>docker ps</code>.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>Docker Compose is a tool for defining and running multi-container
stacks in a YAML file. They can also serve as a way of structuring and
documenting <code>docker run</code> commands for single containers.</li>
<li>Instructions are saved in a <code>docker-compose.yml</code> file,
where services, networks, and volumes are defined.</li>
<li>Each <code>service</code> is a separate container, and it can be
fully configured from within the file.</li>
<li>Bind mounts and <code>volumes</code> can be declared for each
service, and they can be shared between containers too.</li>
<li>You can define <code>networks</code>, which can be used to connect
or isolate containers from each other.</li>
<li>All the services, volumes and networks are started together using
the <code>docker compose up</code> command.</li>
<li>They can be stopped using the <code>docker compose down</code>
command.</li>
<li>Container images can be built as the services are spun up by using
the <code>--build</code> flag.</li>
<li>The order in which services start can be controlled using the
<code>depends_on</code> key.</li>
<li>A <code>healthcheck</code> can be defined to verify the status of a
service. These are commands run from within the container to make sure
it is <em>ready</em>.</li>
</ul></div>
</div>
</div>
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/dockerfiles.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/docker-compose-microservices.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/dockerfiles.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Creating Your Own
        </a>
        <a class="chapter-link float-end" href="../instructor/docker-compose-microservices.html" rel="next">
          Next: And they lived...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/UoMResearchIT/docker-introduction/edit/main/episodes/docker-compose.Rmd" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/UoMResearchIT/docker-introduction/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/UoMResearchIT/docker-introduction/" class="external-link">Source</a></p>
				<p><a href="https://github.com/UoMResearchIT/docker-introduction/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.12" class="external-link">sandpaper (0.16.12)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.6" class="external-link">varnish (1.0.6)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://uomresearchit.github.io/docker-introduction/instructor/docker-compose.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Using Docker Compose",
  "creativeWorkStatus": "active",
  "url": "https://uomresearchit.github.io/docker-introduction/instructor/docker-compose.html",
  "identifier": "https://uomresearchit.github.io/docker-introduction/instructor/docker-compose.html",
  "dateCreated": "2015-04-18",
  "dateModified": "2025-06-10",
  "datePublished": "2025-06-10"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo --><script>
          var _paq = window._paq = window._paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(["setDomains", ["*.lessons.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
          _paq.push(["setDoNotTrack", true]);
          _paq.push(["disableCookies"]);
          _paq.push(["trackPageView"]);
          _paq.push(["enableLinkTracking"]);
          (function() {
              var u="https://matomo.carpentries.org/";
              _paq.push(["setTrackerUrl", u+"matomo.php"]);
              _paq.push(["setSiteId", "1"]);
              var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0];
              g.async=true; g.src="https://matomo.carpentries.org/matomo.js"; s.parentNode.insertBefore(g,s);
          })();
        </script><!-- End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

