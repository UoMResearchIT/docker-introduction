---
title: Configuring containers
teaching: 99
exercises: 99
---

XXX

::::::::::::::::::::::::::::::::::::::: objectives
- XXX
::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions
- XXX
::::::::::::::::::::::::::::::::::::::::::::::::::

## Setting the environment

One other interesting reading from the SPUC README is the presence of an environment variable, `EXPORT` which can be set to `True` to enable an API endpoint for exporting the unicorn sightings.

This sounds like a useful feature, but how can we set an environment variable in a container?

Thankfully this is quite straightforward, we can use the `-e` flag to set an environment variable in a container.

Modifying our run command again:

```bash
docker stop spuc_container
docker run -d --rm --name spuc_container -p 8321:8321 -v ./print.config:/spuc/config/print.config -v spuc-volume:/spuc/output -e EXPORT=true spuacv/spuc:latest
docker logs spuc_container
```
```output
[...]
::::: Initializing SPUC...
::::: Units set to Imperial Unicorn Hoove Candles [iuhc].

Welcome to the Space Purple Unicorn Counter!
::::: Try 'curl -X PUT localhost:8321/unicorn_spotted?location=moon\&brightness=100' to record a unicorn sighting!
::::: Or 'curl localhost:8321/export' to download the unicorn sightings file!
```

And now we can see that the export endpoint is available!

```bash
curl localhost:8321/export
```
```output
time,brightness,unit
2024-10-11 14:43:42.060883,100,iuhc
2024-10-11 14:43:48.064323,400,iuhc
2024-10-11 14:43:49.972220,10,iuhc
```

This is great! No need to bind mount or exec to get the data out of the container, we can just use the API endpoint.

Defaulting to network style connections is very common in Docker containers and saves a lot of hassle.

Environment variables are a very common tool for configuring containers. They are used to set things like API keys, database connection strings, and other configuration options.

## Passing parameters

Finally, we must address a very serious shortcoming of the SPUC container. It is recording the brightness of the unicorns in Imperial Unicorn Hoove Candles (iuhc)! This is a very outdated unit and we **must** change it to metric.

Fortunately the SPUC README tells us that we can pass a parameter to the container to set the units to metric. This is done by passing a parameter to the container when it is run, overriding the default command.

```bash
docker stop spuc_container
docker run -d --rm --name spuc_container -p 8321:8321 -v ./print.config:/spuc/config/print.config -v spuc-volume:/spuc/output -e EXPORT=true spuacv/spuc:latest --units iulu
curl -X PUT localhost:8321/unicorn_spotted?location=earth\&brightness=10
curl localhost:8321/export/
```
```output
time,brightness,unit
2024-10-11 14:43:42.060883,100,iuhc
2024-10-11 14:43:48.064323,400,iuhc
2024-10-11 14:43:49.972220,10,iuhc
2024-10-11 15:30:27.823367,10,iulu
```

::::::::::::::::::::::::::::: callout
You can also override the entrypoint of a container using the `--entrypoint` flag. This is useful if you want to run a different command in the container, or if you want to run the container interactively.

You may recall:

```bash
docker inspect spuacv/spuc:latest -f "Entrypoint: {{.Config.Entrypoint}} Command: {{.Config.Cmd}}"
Entrypoint: [python /spuc/spuc.py] Command: [--units iuhc]
```

That SPUC has an entrypoint of `python /spuc/spuc.py` making it hard to interact with. We can override this using the `--entrypoint` flag.

```bash
docker run -it --rm --entrypoint /bin/sh spuacv/spuc:latest
```

::::::::::::::::::::::::::::::::::::::: challenge
Which of these are valid entrypoint and command combinations for the SPUC container? What are the advantages and disadvantages of each?

| | Entrypoint | Command |
|-|------------|---------|
|A| `python /spuc/spuc.py --units iuhc` | |
|B| `python /spuc/spuc.py` | `--units iuhc` |
|C| `python` | `/spuc/spuc.py --units iuhc` |
|D| | `python /spuc/spuc.py --units iuhc` |

::::::::::::::::::::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::: solution
These are all valid combinations! The best choice depends on the use case.

A) This combination bakes the command and the parameters into the image. This is useful if the command is always the same and the specified parameters are unlikely to change (although more may be appended).

B) This combination allows the command's arguments to be changd easily while baking in which Python script to run.

C) This combination allows the Python script to be changed easily, which is more likely to be bad than good!

D) This combination allows maximum flexibility, but it requires the user to know the correct command to run.
::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::

## Summary

In this section, we have learned about volumes and bind mounts, two ways to allow a container to access the host filesystem. We have used these to persist data between runs of a container and to share files with a container.

We have learned how to set environment variables and pass parameters to containers, two ways to configure the behaviour of a container.

SPUC is now running with the correct units and we can export the unicorn sightings using the API endpoint! And we are no longer losing our unicorn sightings between runs of the container.

::::::::::::::::::::::::::::::::::::::: keypoints
- Volumes and bind mounts are two ways to allow a container to access the host filesystem.
- Environment variables and parameters can be used to configure the behaviour of a container.
::::::::::::::::::::::::::::::::::::::::::::::::::